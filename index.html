<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>eDrawings Upload Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --accent:#111827;
    --green:#10b981; --red:#ef4444; --link:#2563eb;
  }
  html,body{height:100%;margin:0;background:var(--bg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-rows:1fr 1fr;min-height:100vh;gap:16px;padding:16px;box-sizing:border-box}
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:20px;display:flex;flex-direction:column}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  h1{margin:0 0 6px 0;font-size:20px}
  .muted{color:var(--muted)}
  .btn{appearance:none;border:none;background:var(--accent);color:white;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.alt{background:#374151}
  .btn.copy{background:var(--green)}
  .link{color:var(--link);text-decoration:none}
  .dropzone{
    flex:1;min-height:240px;border:2px dashed #d1d5db;border-radius:14px;background:#fafafa;
    display:flex;align-items:center;justify-content:center;text-align:center;padding:20px
  }
  .dropzone.drag{background:#eef2ff;border-color:#93c5fd}
  .fileline{display:flex;align-items:center;gap:10px;margin-top:12px;word-break:break-all}
  .grid{overflow:auto;margin-top:12px;border:1px solid #e5e7eb;border-radius:12px}
  table{border-collapse:collapse;width:100%}
  th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:left}
  th{background:#f8fafc;font-weight:600;font-size:14px}
  .status{min-height:22px;color:var(--muted);margin-top:8px}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#111827;font-size:12px}
  .right{margin-left:auto}
  .auth-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
  .auth-modal-content{background:white;padding:24px;border-radius:16px;max-width:500px;width:90%}
  .form-group{margin-bottom:16px}
  label{display:block;margin-bottom:6px;font-weight:600}
  input[type="text"], input[type="password"]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;box-sizing:border-box}
  .help-text{font-size:14px;color:var(--muted);margin-top:4px}
</style>
</head>
<body>
<div class="wrap">

  <!-- TOP: Upload area -->
  <section class="card" id="top">
    <div class="row">
      <div>
        <h1>Upload eDrawings HTML</h1>
        <div class="muted">Drag & drop your <strong>.html</strong> file below. You'll get a shareable link immediately.</div>
      </div>
      <div class="right row">
        <span id="userBadge" class="chip">Not signed in</span>
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="logoutBtn" class="btn alt" style="display:none">Sign out</button>
      </div>
    </div>

    <div id="dropzone" class="dropzone">
      <div>
        <div style="font-size:18px;margin-bottom:6px">Drop your <b>eDrawings .html</b> file here</div>
        <div class="muted">…or click to choose a file</div>
      </div>
      <input id="fileInput" type="file" accept=".html" style="display:none" />
    </div>

    <div class="fileline" id="selectedFile" style="display:none"></div>

    <div class="row" id="afterUpload" style="display:none">
      <input id="shareUrl" type="text" readonly style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
      <button id="copyBtn" class="btn copy">Copy link</button>
      <a id="openBtn" class="btn" href="#" target="_blank">Open</a>
    </div>

    <div class="status" id="status"></div>
  </section>

  <!-- BOTTOM: Recent uploads -->
  <section class="card">
    <div class="row">
      <h1 style="margin:0">Recent uploads</h1>
      <button id="refreshBtn" class="btn alt right">Refresh</button>
    </div>
    <div class="grid">
      <table>
        <thead>
          <tr><th>File</th><th>Uploader</th><th>Date</th><th>Link</th></tr>
        </thead>
        <tbody id="recentTbody">
          <tr><td colspan="4" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

</div>

<!-- Auth Modal -->
<div id="authModal" class="auth-modal" style="display:none">
  <div class="auth-modal-content">
    <h2>GitHub Authentication</h2>
    <p>To upload files, you need to provide a GitHub Personal Access Token:</p>
    
    <div class="form-group">
      <label for="tokenInput">Personal Access Token:</label>
      <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
      <div class="help-text">
        Create one at: <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings → Developer settings → Personal access tokens</a><br>
        Required scopes: <strong>repo</strong> (or public_repo for public repos only)
      </div>
    </div>

    <div class="form-group">
      <label for="usernameInput">GitHub Username (optional):</label>
      <input type="text" id="usernameInput" placeholder="Your GitHub username">
      <div class="help-text">This will be shown as the uploader name</div>
    </div>

    <div class="row">
      <button id="saveTokenBtn" class="btn">Save & Sign In</button>
      <button id="cancelAuthBtn" class="btn alt">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG — SET THESE FIRST
   ========================= */
// Your GitHub org/user and repo that holds the HTML files
const GH_OWNER = 'DamienGajda';      
const GH_REPO  = 'edrawings';       
// The public base URL where Pages serves the files
const PAGES_BASE = 'https://DamienGajda.github.io/edrawings/'; 

const els = {
  dz: document.getElementById('dropzone'),
  fi: document.getElementById('fileInput'),
  sel: document.getElementById('selectedFile'),
  login: document.getElementById('loginBtn'),
  logout: document.getElementById('logoutBtn'),
  userBadge: document.getElementById('userBadge'),
  status: document.getElementById('status'),
  shareUrl: document.getElementById('shareUrl'),
  copyBtn: document.getElementById('copyBtn'),
  openBtn: document.getElementById('openBtn'),
  afterUpload: document.getElementById('afterUpload'),
  recentTbody: document.getElementById('recentTbody'),
  refreshBtn: document.getElementById('refreshBtn'),
  authModal: document.getElementById('authModal'),
  tokenInput: document.getElementById('tokenInput'),
  usernameInput: document.getElementById('usernameInput'),
  saveTokenBtn: document.getElementById('saveTokenBtn'),
  cancelAuthBtn: document.getElementById('cancelAuthBtn'),
};

/* ---------- Token storage ---------- */
function setToken(t){localStorage.setItem('gh_token', t)}
function getToken(){return localStorage.getItem('gh_token')}
function clearToken(){localStorage.removeItem('gh_token')}

function setUsername(u){localStorage.setItem('gh_username', u)}
function getUsername(){return localStorage.getItem('gh_username')}
function clearUsername(){localStorage.removeItem('gh_username')}

/* ---------- Auth UI ---------- */
function setSignedIn(username){
  els.userBadge.textContent = username ? `Signed in: ${username}` : 'Not signed in';
  els.login.style.display = username ? 'none' : '';
  els.logout.style.display = username ? '' : 'none';
}

/* ---------- Authentication ---------- */
function beginLogin(){
  els.tokenInput.value = '';
  els.usernameInput.value = getUsername() || '';
  els.authModal.style.display = 'flex';
  els.tokenInput.focus();
}

async function saveToken(){
  const token = els.tokenInput.value.trim();
  const username = els.usernameInput.value.trim();
  
  if(!token){
    els.status.textContent = 'Please enter a token.';
    return;
  }

  els.status.textContent = 'Verifying token...';
  
  // Test the token by making a simple API call
  try {
    const response = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github+json'
      }
    });

    if (response.ok) {
      const userData = await response.json();
      
      // Save token and username
      setToken(token);
      const displayName = username || userData.login;
      setUsername(displayName);
      
      // Update UI
      setSignedIn(displayName);
      els.authModal.style.display = 'none';
      els.status.textContent = 'Successfully signed in!';
      
      // Refresh the recent uploads
      renderRecent();
    } else {
      const errorData = await response.json().catch(() => ({}));
      els.status.textContent = 'Invalid token: ' + (errorData.message || 'Please check your token');
    }
  } catch (error) {
    els.status.textContent = 'Error verifying token: ' + error.message;
  }
}

/* ---------- GitHub API helpers ---------- */
async function gh(path, opts={}){
  const token = getToken();
  const headers = { 'Accept':'application/vnd.github+json' };
  if(token) headers['Authorization'] = 'Bearer ' + token;
  return fetch(`https://api.github.com${path}`, {headers, ...opts});
}

async function listFiles(){
  // list repo root; filter to .html
  const r = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/`);
  if(!r.ok){ return []; }
  const arr = await r.json();
  return arr.filter(x => x.type==='file' && x.name.toLowerCase().endsWith('.html'));
}

async function getLatestCommitForPath(path){
  const r = await gh(`/repos/${GH_OWNER}/${GH_REPO}/commits?path=${encodeURIComponent(path)}&per_page=1`);
  if(!r.ok) return null;
  const [commit] = await r.json();
  return commit || null;
}

function fileSafeName(name){
  return name.replace(/\s+/g,'_').replace(/[^\w\-\.]/g,'');
}

function toBase64(arrayBuffer){
  let binary = '';
  const bytes = new Uint8Array(arrayBuffer);
  const len = bytes.byteLength;
  for(let i=0;i<len;i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

/* ---------- Upload flow ---------- */
async function uploadFile(file){
  els.status.textContent = 'Uploading…';
  const token = getToken();
  if(!token){
    els.status.textContent = 'Please sign in first.';
    return;
  }

  try {
    // First, test repository access
    els.status.textContent = 'Checking repository access...';
    const repoTest = await gh(`/repos/${GH_OWNER}/${GH_REPO}`);
    if (!repoTest.ok) {
      const repoError = await repoTest.json().catch(() => ({}));
      els.status.textContent = `Repository access failed (${repoTest.status}): ${repoError.message || 'Repository not found or no access'}. Check: 1) Repository exists 2) Token has repo permissions 3) Repository name is correct`;
      return;
    }

    els.status.textContent = 'Processing file...';
    const arrayBuf = await file.arrayBuffer();
    const b64 = toBase64(arrayBuf);
    const filename = fileSafeName(file.name || 'model.html');

    // check if file exists to pass sha for update
    els.status.textContent = 'Checking if file exists...';
    let existingSha = null;
    const head = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(filename)}`);
    if(head.ok){
      const meta = await head.json();
      existingSha = meta.sha;
      els.status.textContent = 'Updating existing file...';
    } else {
      els.status.textContent = 'Creating new file...';
    }

    const username = getUsername();
    const message = existingSha
      ? `Update ${filename} by ${username || 'unknown'}`
      : `Add ${filename} by ${username || 'unknown'}`;

    const body = {
      message,
      content: b64,
      branch: 'main'
    };
    if(existingSha) body.sha = existingSha;

    els.status.textContent = 'Uploading to GitHub...';
    const put = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(filename)}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    if(!put.ok){
      const err = await put.json().catch(()=>({}));
      let errorMsg = `Upload failed (${put.status}): ${err.message || 'Unknown error'}`;
      
      // Provide specific guidance based on error
      if (put.status === 404) {
        errorMsg += '. Check: 1) Repository exists 2) Token has "repo" permissions 3) Repository name/owner is correct';
      } else if (put.status === 401) {
        errorMsg += '. Token is invalid or expired';
      } else if (put.status === 403) {
        errorMsg += '. Token lacks required permissions - needs "repo" scope';
      } else if (put.status === 409) {
        errorMsg += '. File conflict - try refreshing and uploading again';
      }
      
      els.status.textContent = errorMsg;
      console.error('GitHub API Error:', {
        status: put.status,
        error: err,
        repo: `${GH_OWNER}/${GH_REPO}`,
        filename: filename
      });
      return;
    }

    els.status.textContent = 'Uploaded ✔';
    const url = PAGES_BASE + encodeURIComponent(filename);
    els.shareUrl.value = url;
    els.afterUpload.style.display = '';
    els.openBtn.href = url;

    // refresh recent list
    renderRecent();
  } catch (error) {
    els.status.textContent = 'Upload error: ' + error.message;
    console.error('Upload error:', error);
  }
}

/* ---------- UI wiring ---------- */
els.login.addEventListener('click', beginLogin);
els.logout.addEventListener('click', ()=>{ 
  clearToken(); 
  clearUsername();
  setSignedIn(null); 
});
els.copyBtn.addEventListener('click', ()=>{
  els.shareUrl.select(); 
  navigator.clipboard.writeText(els.shareUrl.value).then(() => {
    els.status.textContent = 'Link copied to clipboard.';
  }).catch(() => {
    // Fallback for older browsers
    document.execCommand('copy');
    els.status.textContent = 'Link copied to clipboard.';
  });
});
els.refreshBtn.addEventListener('click', ()=>renderRecent());

// Auth modal events
els.saveTokenBtn.addEventListener('click', saveToken);
els.cancelAuthBtn.addEventListener('click', ()=>{
  els.authModal.style.display = 'none';
});

// Allow Enter key in token input
els.tokenInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    saveToken();
  }
});

/* Drag & drop */
['dragenter','dragover'].forEach(ev=>{
  els.dz.addEventListener(ev, e=>{ e.preventDefault(); els.dz.classList.add('drag'); });
});
['dragleave','drop'].forEach(ev=>{
  els.dz.addEventListener(ev, e=>{ e.preventDefault(); els.dz.classList.remove('drag'); });
});
els.dz.addEventListener('click', ()=>els.fi.click());
els.dz.addEventListener('drop', e=>{
  const f = e.dataTransfer?.files?.[0];
  if(f){ showSelected(f); uploadFile(f); }
});
els.fi.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if(f){ showSelected(f); uploadFile(f); }
});
function showSelected(f){
  els.sel.style.display = '';
  els.sel.textContent = `Selected: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
  els.afterUpload.style.display = 'none';
  els.status.textContent = '';
}

/* ---------- Recent uploads ---------- */
async function renderRecent(){
  els.recentTbody.innerHTML = `<tr><td colspan="4" class="muted">Loading…</td></tr>`;
  const files = await listFiles();
  if(!files.length){
    els.recentTbody.innerHTML = `<tr><td colspan="4" class="muted">No uploads yet.</td></tr>`;
    return;
  }

  // sort by latest commit date
  const rows = [];
  for(const f of files){
    const commit = await getLatestCommitForPath(f.path);
    const when = commit?.commit?.committer?.date || null;
    const uploader = (commit?.author?.login) || (commit?.committer?.login) || '—';
    rows.push({
      name: f.name,
      url: PAGES_BASE + encodeURIComponent(f.name),
      uploader, when: when ? new Date(when) : null
    });
  }
  rows.sort((a,b)=>(b.when?.getTime()||0)-(a.when?.getTime()||0));

  els.recentTbody.innerHTML = rows.map(r=>{
    const dateStr = r.when ? r.when.toLocaleString() : '—';
    return `<tr>
      <td>${r.name}</td>
      <td>${r.uploader}</td>
      <td>${dateStr}</td>
      <td><a class="link" href="${r.url}" target="_blank">Open</a></td>
    </tr>`;
  }).join('');
}

/* ---------- Boot ---------- */
(async function boot(){
  const username = getUsername();
  setSignedIn(username);
  renderRecent();
})();
</script>
</body>
</html>
